name: Live Scoreboard Refresh

on:
  # ğŸˆ Schedule (UTC times)
  schedule:
    # Thursday nights (8 PMâ€“Midnight ET â†’ Fri 00â€“04 UTC), every 15 minutes
    - cron: "*/15 0-3 * * FRI"

    # Sunday (1 PMâ€“Midnight ET â†’ Sun 17â€“23 UTC, Mon 00â€“04 UTC)
    - cron: "*/15 17-23 * * SUN"
    - cron: "*/15 0-3 * * MON"

    # Monday nights (8 PMâ€“Midnight ET â†’ Tue 00â€“04 UTC), every 5 minutes
    - cron: "*/5 0-3 * * TUE"

  # Manual trigger
  workflow_dispatch:
    inputs:
      force_refresh:
        description: "Force Power BI refresh even if no games are active"
        required: false
        default: "false"

permissions:
  contents: write

concurrency:
  group: live-scoreboard-refresh
  cancel-in-progress: true

jobs:
  refresh:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------
      # ğŸ—“ï¸ Step 1: Skip if outside NFL season (Sep 1 â€“ Jan 15)
      # --------------------------------------------------------
      - name: Check if current date is within NFL season
        id: season_check
        run: |
          TODAY=$(date -u +%Y-%m-%d)
          MONTH=$(date -u +%m)
          DAY=$(date -u +%d)
          RUN_SEASON=false

          if [ $MONTH -ge 9 ] && [ $MONTH -le 12 ]; then
            RUN_SEASON=true
          fi
          if [ $MONTH -eq 1 ] && [ $DAY -le 15 ]; then
            RUN_SEASON=true
          fi

          if [ "$RUN_SEASON" = "false" ]; then
            echo "âš ï¸ $TODAY is outside NFL season. Skipping workflow."
            echo "IN_SEASON=false" >> $GITHUB_ENV
            exit 0
          else
            echo "ğŸˆ NFL season active ($TODAY). Continuing..."
            echo "IN_SEASON=true" >> $GITHUB_ENV
          fi

      - name: Skip notice (offseason)
        if: env.IN_SEASON != 'true'
        run: echo "ğŸ›‘ Skipping job (offseason months)."

      # --------------------------------------------------------
      # ğŸ§° Step 2: Setup
      # --------------------------------------------------------
      - name: Checkout repo
        if: env.IN_SEASON == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: env.IN_SEASON == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: env.IN_SEASON == 'true'
        run: pip install pandas requests jq pytz

      - name: Cron heartbeat
        if: env.IN_SEASON == 'true'
        run: |
          echo "â° Cron fired at: $(date -u +'%Y-%m-%d %H:%M:%S') UTC"
          echo "Tip: UTC = ET + 4 (during Daylight Time)."

      # --------------------------------------------------------
      # ğŸˆ Step 3: Check game status
      # --------------------------------------------------------
      - name: Check if games are active
        if: env.IN_SEASON == 'true'
        id: gamestatus
        run: python NFLgameStatus.py
        continue-on-error: true

      - name: Parse NFL status JSON
        if: env.IN_SEASON == 'true' && always()
        run: |
          if [ -f "nfl_status.json" ]; then
            WEEK_NUM=$(jq -r '.week_number' nfl_status.json)
            GAMES_ACTIVE=$(jq -r '.games_active' nfl_status.json)
            REFRESH_INTERVAL=$(jq -r '.refresh_interval' nfl_status.json)
            TIMESTAMP_ET=$(jq -r '.timestamp_et' nfl_status.json)
            echo "WEEK_NUM=$WEEK_NUM" >> $GITHUB_ENV
            echo "GAMES_ACTIVE=$GAMES_ACTIVE" >> $GITHUB_ENV
            echo "REFRESH_INTERVAL=$REFRESH_INTERVAL" >> $GITHUB_ENV
            echo "TIMESTAMP_ET=$TIMESTAMP_ET" >> $GITHUB_ENV
            echo "ğŸ“… Week: $WEEK_NUM | ğŸˆ Games active: $GAMES_ACTIVE | ğŸ” Refresh: ${REFRESH_INTERVAL}m | ğŸ•’ $TIMESTAMP_ET"
          else
            echo "âš ï¸ nfl_status.json not found â€” likely API error."
            echo "GAMES_ACTIVE=false" >> $GITHUB_ENV
          fi

      # --------------------------------------------------------
      # â¸ï¸ Step 4: Skip if no active games
      # --------------------------------------------------------
      - name: Skip if no active games
        if: env.GAMES_ACTIVE != 'true'
        run: echo "ğŸ˜´ No live games right now. Skipping score refresh."

      # --------------------------------------------------------
      # ğŸ”„ Step 5: Refresh data if games are active
      # --------------------------------------------------------
      - name: Refresh Scores for active week
        if: env.GAMES_ACTIVE == 'true'
        run: python score_details.py --week $WEEK_NUM

      # --------------------------------------------------------
      # ğŸ•’ Step 6: Update LastUpdate.csv timestamps
      # --------------------------------------------------------
      - name: Update LastUpdate.csv
        if: env.GAMES_ACTIVE == 'true'
        run: python update_lastmodified.py

      # --------------------------------------------------------
      # ğŸ’¾ Step 7: Commit updated CSV + timestamp
      # --------------------------------------------------------
      - name: Commit updated data
        if: env.GAMES_ACTIVE == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet --exit-code data/Scores.csv data/LastUpdate.csv; then
            echo "No data changes detected."
            echo "DATA_CHANGED=false" >> $GITHUB_ENV
          else
            echo "ğŸ“ˆ New data detected â€” committing update."
            git add data/Scores.csv data/LastUpdate.csv || true
            git commit -m "Auto update live scores (Week $WEEK_NUM)" || echo "No changes to commit"
            git push || echo "Nothing to push"
            echo "DATA_CHANGED=true" >> $GITHUB_ENV
          fi

      # --------------------------------------------------------
      # ğŸš€ Step 8: Get token + trigger Power BI dataset refresh (diagnostic)
      # --------------------------------------------------------
      - name: Ensure curl certificates
        if: env.IN_SEASON == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates

      - name: Test outbound connectivity
        run: |
          ping -c 2 login.microsoftonline.com || true
          curl -I https://login.microsoftonline.com || true

      - name: Test network connectivity to Azure
        run: |
          echo "ğŸŒ Checking DNS and SSL to login.microsoftonline.com"
          curl -vI https://login.microsoftonline.com/common/oauth2/v2.0/token || true
          echo "ğŸŒ Checking api.powerbi.com"
          curl -vI https://api.powerbi.com/ || true

      
      - name: Get Power BI token and trigger refresh (diagnostic)
        if: (env.GAMES_ACTIVE == 'true' && env.DATA_CHANGED == 'true') || github.event.inputs.force_refresh == 'true'
        env:
          TENANT_ID: ${{ secrets.PBI_TENANT_ID }}
          CLIENT_ID: ${{ secrets.PBI_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.PBI_CLIENT_SECRET }}
          WORKSPACE_ID: ${{ secrets.PBI_WORKSPACE_ID }}
          DATASET_ID: ${{ secrets.PBI_DATASET_ID }}
        run: |
          set +e
          echo "ğŸ” Checking secrets exist (lengths only):"
          echo "TENANT_ID len: ${#TENANT_ID}"
          echo "CLIENT_ID len: ${#CLIENT_ID}"
          echo "CLIENT_SECRET len: ${#CLIENT_SECRET}"
          echo "WORKSPACE_ID len: ${#WORKSPACE_ID}"
          echo "DATASET_ID len: ${#DATASET_ID}"

          if [ -z "$TENANT_ID" ] || [ -z "$CLIENT_ID" ] || [ -z "$CLIENT_SECRET" ]; then
            echo "âŒ One or more required secrets are empty."
            exit 1
          fi

          TOKEN_URL="https://login.microsoftonline.com/$TENANT_ID/oauth2/v2.0/token"
          echo "ğŸ” Attempt 1 (modern .scope)"
          RESP1=$(curl -s -w " HTTP_STATUS:%{http_code}" -X POST "$TOKEN_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials&client_id=$CLIENT_ID&client_secret=$CLIENT_SECRET&scope=https://analysis.windows.net/powerbi/api/.default")

          BODY1="${RESP1% HTTP_STATUS:*}"
          CODE1="${RESP1##*HTTP_STATUS:}"
          echo "HTTP $CODE1"
          echo "$BODY1" | jq -r '.error, .error_description // empty' || true
          TOKEN=$(echo "$BODY1" | jq -r '.access_token // empty')

          if [ -z "$TOKEN" ]; then
            echo "ğŸ” Attempt 2 (legacy resource)"
            TOKEN_URL_V1="https://login.microsoftonline.com/$TENANT_ID/oauth2/token"
            RESP2=$(curl -s -w " HTTP_STATUS:%{http_code}" -X POST "$TOKEN_URL_V1" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "grant_type=client_credentials&client_id=$CLIENT_ID&client_secret=$CLIENT_SECRET&resource=https://analysis.windows.net/powerbi/api")

            BODY2="${RESP2% HTTP_STATUS:*}"
            CODE2="${RESP2##*HTTP_STATUS:}"
            echo "HTTP $CODE2"
            echo "$BODY2" | jq -r '.error, .error_description // empty' || true
            TOKEN=$(echo "$BODY2" | jq -r '.access_token // empty')
          fi

          if [ -z "$TOKEN" ]; then
            echo "âŒ Still no access token. See error details above."
            exit 1
          fi

          echo "âœ… Got access token. Triggering dataset refreshâ€¦"
          REFRESH_URL="https://api.powerbi.com/v1.0/myorg/groups/$WORKSPACE_ID/datasets/$DATASET_ID/refreshes"
          R=$(curl -s -o response.json -w "%{http_code}" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -X POST "$REFRESH_URL")

          echo "Power BI POST /refreshes -> HTTP $R"
          cat response.json || true
          if [ "$R" = "202" ]; then
            echo "ğŸ‰ Refresh queued."
          else
            echo "âš ï¸ Unexpected status $R"
            exit 1
          fi

      # --------------------------------------------------------
      # ğŸ“‹ Step 9: Run summary
      # --------------------------------------------------------
      - name: Run summary
        if: always()
        run: |
          echo "ğŸ§¾ --- SUMMARY ---"
          echo "ğŸ“… Week: ${WEEK_NUM:-unknown}"
          echo "ğŸˆ Games active: ${GAMES_ACTIVE:-unknown}"
          echo "ğŸ” Refresh interval: ${REFRESH_INTERVAL:-unknown} min"
          echo "ğŸ•’ Timestamp (ET): ${TIMESTAMP_ET:-unknown}"
          echo "ğŸ’¾ Data changed: ${DATA_CHANGED:-unknown}"
